(function(a,b){if(typeof module=="object"&&module.exports){module.exports=b()}else{if(typeof define=="function"&&define.amd){define(b)}else{a.JSM=b()}}}(this,function(){function c(f){for(var d=1;d<arguments.length;d++){var e=arguments[d];for(var g in e){if(f[g]===undefined){f[g]=e[g]}}}return f}var b={};function a(){$.ex=window.external;$.dlg=function(f,d){var e=function(){if(typeof d!=="undefined"&&d!=null){$.confirm(f,function(g){if(g){if(typeof d==="string"&&d=="exit"){(typeof $.ex.Close!=="undefined")?$.ex.Close():open(location,"_self").close()}else{d()}}return true}).cancel("\u53d6\u6d88").ok("\u786e\u5b9a")}else{$.alert(f)}};window.setTimeout(e,0);return false};this.opts=c({},a.defaults,b)}a.defaults={};a.serverurl=/*window.location.hostname*/"192.168.10.128"+":8000/aggregation/?ch=0&u={0}&ts={1}&token={2}&data=debug";a.WS=function(){this.config={url:""};this.socket=null;this.state=function(){return(this.socket!==undefined&&this.socket!=null)?this.socket.readyState:0};this.host="";this.init=function(d){this.config=$.extend(true,this.config,d);return this};this.isJSON=function(g){if(typeof g=="string"){try{var f=JSON.parse(g);if(typeof f=="object"&&("data" in f)){return f}else{return null}}catch(d){return null}}};console.log("WebSocket INIT ")};c(a.WS.prototype,{connect:function(){var d=(window.location.protocol=="http:")?"ws://":"wss://";this.host=d+this.config.url;window.WebSocket=window.WebSocket||window.MozWebSocket;if(!window.WebSocket){this.error("Error: WebSocket is not supported .");return}this.socket=new WebSocket(this.host);this.socket.owner=this;this.socket.onopen=function(e){this.owner.onopen(e)};this.socket.onmessage=function(e){var g=this.owner;var f=g.isJSON(e.data);if(f==null){f={code:0,flag:0,data:""}}g.onmessage(f)};this.socket.onclose=function(e){var f=this.owner;f.onclose(e);f.socket=null};this.socket.onerror=function(e){this.onerror({type:e.type,state:e.target.readyState,message:e.target.url})}.bind(this);return this},error:function(d){this.onerror=d;return this},send:function(d){var e=this;if(e.socket&&e.socket.readyState==1){e.socket.send(d);return true}e.onerror({type:"send",state:0,message:"please connect to the server first !!!"});return false},receive:function(d){this.onmessage=d;return this},close:function(){var d=this;if(d.socket!==undefined&&d.socket!=null){d.socket.close()}else{d.onerror({type:"close",state:0,message:"this socket is not available"})}},onmessage:function(d){console.log("WebSocket MESSAGE")},onopen:function(d){console.log("WebSocket OPENED")},onclose:function(d){console.log("WebSocket CLOSE")},onerror:function(d){console.log("WebSocket ERROR")}});String.prototype.rpl=function(){return this.replace(/\#/g,"")};c(a.prototype,{version:"1.0.0",language:{},user:{ID:0,Username:"",Nickname:"anonymous",Enable:false,Role:0,Token:"",LoginTime:0,isSuper:function(){return this.Role&&this.Role==9}},cache:{setItem:function(d,e){localStorage.setItem(d,e)},getItem:function(d){return localStorage.getItem(d)},put:function(h,d,j){try{if(!localStorage){return false}if(!j||isNaN(j)){j=60}var g=(new Date()-1)+j*1000;var f={val:d,exp:g};localStorage.setItem(h,JSON.stringify(f))}catch(i){}},get:function(h){try{if(!localStorage){return false}var g=localStorage.getItem(h);var d=JSON.parse(g);var f=new Date()-1;if(!d){return null}if(f>d.exp){this.remove(h);return""}return d.val}catch(i){this.remove(h);return null}},remove:function(d){if(!localStorage){return false}localStorage.removeItem(d)},clear:function(){if(!localStorage){return false}localStorage.clear()}},loadCSS:function(e){var d=$("<link>");$("head").append(d);d.attr({rel:"stylesheet",type:"text/css",href:e})},setLanguage:function(d){if(d===undefined){d=this.cache.getItem("lang");if(!d){d="zh_CN"}}$.getJSON("/mask/language/"+d+".json",null,function(f,g,e){$("[lang]").each(function(h,i){console.log(i.lang+"="+f[i.lang]);switch(this.tagName.toLowerCase()){case"input":$(this).val(f[i.lang]);break;default:$(this).html(f[i.lang]);break}});if(typeof translate!=="undefined"){translate(f)}$.extend(true,$.jsm.language,f)});this.cache.setItem("lang",d)},getMultiCSS:function(d,f){var e=$.map(d,function(g){return $.jsm.loadCSS((f||"")+g)});e.push($.Deferred(function(g){$(g.resolve)}));return $.when.apply($,e)},getMultiScripts:function(d,f){var e=$.map(d,function(g){return $.getScript((f||"")+g)});e.push($.Deferred(function(g){$(g.resolve)}));return $.when.apply($,e)},api:{config:{url:a.serverurl},init:function(d){this.config=$.extend(true,this.config,d);return this},isJSON:function(g){if(typeof g=="string"){try{var f=JSON.parse(g);if(typeof f=="object"&&("data" in f)){return f}else{return null}}catch(d){return null}}},connect:function(){var f=(window.location.protocol=="http:")?"ws://":"wss://";var e=this,d=$.jsm.user;e.host=f+e.config.url.format(d.ID,d.LoginTime,d.Token);window.WebSocket=window.WebSocket||window.MozWebSocket;if(!window.WebSocket){this.error("Error: WebSocket is not supported .");return}this.socket=new WebSocket(this.host);this.socket.onopen=function(){$.jsm.api.onopen()};this.socket.onmessage=function(g){var i=$.jsm.api;var h=i.isJSON(g.data);if(h==null){h={code:0,flag:0,data:""}}i.onmessage(h)};this.socket.onclose=function(){$.jsm.api.onclose();$.jsm.api.socket=null};this.socket.onerror=function(g){this.onerror({type:g.type,state:g.target.readyState,message:g.target.url})}.bind(this);return this},error:function(d){this.onerror=d;return this},send:function(d){var e=this;if(e.socket&&e.socket.readyState==1){e.socket.send(d);return true}e.onerror({type:"send",state:0,message:"please connect to the server first !!!"});return false},receive:function(d){this.onmessage=d;return this},close:function(){var d=this;if(d.socket!==undefined&&d.socket!=null){d.socket.close()}else{d.onerror({type:"close",state:0,message:"this socket is not available"})}},onmessage:function(d){},onopen:function(){},onclose:function(){},onerror:function(){}},checkUser:function(f){var e={type:"POST",url:"./api.do?pid=101&rsp=102",data:null,datetype:"json"};var d=arguments;e.beforeSend=function(){};e.success=function(h,g,k){var i=h;console.log(URL.page());if(i&&("rt" in i)&&i.rt){try{if("user" in i){$.jsm.user=jQuery.extend(true,$.jsm.user,i.user)}f&&f(i)}catch(j){alert("ERROR:"+j)}}else{if(URL.page()!="login.html"){$.jsm.gotoUrl(top,"/mask/mobile/login.html?fromurl="+encodeURIComponent(window.location.href))}else{f&&f({user:$.jsm.user})}}};e.error=function(){};e.complete=function(g,h){};$.ajax(e)},gotoUrl:function(){var d=arguments;if(d.length>1){d[0].location.replace(d[1])}else{window.location.replace(d[0])}},padLeft:function(e,d){if(e.length>=d){return e}else{return this.padLeft("0"+e,d)}},getURI:function(){var d=arguments,f="",e="./api.do?pid={0}&rsp={1}{2}";if(d.length==2){f="&r={0}".format(parseInt(new Date().getTime()/1000))}return e.format(d[0],d[1],f)},urlsafe_b64encode:function(d){return Base.encode(d).replace(/\+/g,"-").replace(/\//g,"_").replace(/[=]+/,"")},urlsafe_b64decode:function(e){var d=e.replace(/\-/g,"+").replace(/\_/g,"/");var f=d.length%4;if(f>0){d+="====".substr(f)}return Base.decode(d)},signOut:function(d){var e=$.jsm.language;$.confirm('<span style="color:red; font-size:16px; font-weight:bold;">'+e.quit_confirm+"</span>",function(f){if(f){$.get($.jsm.getURI(102,202),function(g){if(g.rt.toBoolean()){$.jsm.gotoUrl(top,"/mask/mobile/login.html?fromurl="+encodeURIComponent(window.location.href))}})}return true}).cancel(e.cancel).ok(e.ok)}});return a}));
